import{$,$$,showToast}from'../core/dom.js';import{isValidCPF,isValidPhoneBR,isValidCEP,isAdult14}from'./validators.js';import{saveCadastro}from'./store.js';function setErr(el,msg){if(!el)return;el.setAttribute('aria-invalid','true');let h=el.nextElementSibling;if(!h||!h.classList.contains('field-error')){h=document.createElement('div');h.className='field-error';el.insertAdjacentElement('afterend',h);}h.textContent=msg;}function clrErr(el){if(!el)return;el.setAttribute('aria-invalid','false');const h=el.nextElementSibling;if(h&&h.classList.contains('field-error'))h.remove();}export function attachFormValidation(form){if(!form)return;let sum=form.querySelector('.error-summary');if(!sum){sum=document.createElement('section');sum.className='error-summary hide';sum.setAttribute('role','alert');sum.innerHTML='<h4>Por favor, corrija os seguintes campos:</h4><ul></ul>';form.prepend(sum);}function validate(){const errs=[];const nome=$('#nome',form);if(!nome.value.trim()){setErr(nome,'Informe seu nome completo.');errs.push({el:nome,msg:'Nome completo obrigatório.'});}else clrErr(nome);const email=$('#email',form);if(!email.validity.valid){setErr(email,'Informe um e-mail válido.');errs.push({el:email,msg:'E-mail inválido.'});}else clrErr(email);const cpf=$('#cpf',form);if(!isValidCPF(cpf.value)){setErr(cpf,'CPF inválido.');errs.push({el:cpf,msg:'CPF inválido.'});}else clrErr(cpf);const tel=$('#telefone',form);if(!isValidPhoneBR(tel.value)){setErr(tel,'Telefone inválido.');errs.push({el:tel,msg:'Telefone inválido.'});}else clrErr(tel);const nasc=$('#nascimento',form);if(!isAdult14(nasc.value)){setErr(nasc,'Você precisa ter pelo menos 14 anos.');errs.push({el:nasc,msg:'Idade mínima: 14 anos.'});}else clrErr(nasc);const log=$('#logradouro',form);if(!log.value.trim()){setErr(log,'Informe o logradouro.');errs.push({el:log,msg:'Logradouro obrigatório.'});}else clrErr(log);const num=$('#numero',form);if(!num.value.trim()){setErr(num,'Informe o número.');errs.push({el:num,msg:'Número obrigatório.'});}else clrErr(num);const bairro=$('#bairro',form);if(!bairro.value.trim()){setErr(bairro,'Informe o bairro.');errs.push({el:bairro,msg:'Bairro obrigatório.'});}else clrErr(bairro);const cep=$('#cep',form);if(!isValidCEP(cep.value)){setErr(cep,'CEP inválido. Ex.: 65000-000');errs.push({el:cep,msg:'CEP inválido.'});}else clrErr(cep);const cidade=$('#cidade',form);if(!cidade.value.trim()){setErr(cidade,'Informe a cidade.');errs.push({el:cidade,msg:'Cidade obrigatória.'});}else clrErr(cidade);const uf=$('#estado',form);if(!uf.value){setErr(uf,'Selecione a UF.');errs.push({el:uf,msg:'UF obrigatória.'});}else clrErr(uf);const termos=form.querySelector('input[name="termos"]');if(!termos.checked){setErr(termos,'É necessário aceitar os termos.');errs.push({el:termos,msg:'Aceite os termos.'});}else clrErr(termos);const ul=sum.querySelector('ul');ul.innerHTML='';if(errs.length){errs.forEach(({el,msg})=>{const id=el.id||el.name;const li=document.createElement('li');li.innerHTML=`<a href="#${id}">${msg}</a>`;ul.appendChild(li);});sum.classList.remove('hide');sum.focus();return{valid:false,errors:errs};}else{sum.classList.add('hide');ul.innerHTML='';return{valid:true,errors:[]};}}form.addEventListener('input',e=>{validate();});form.addEventListener('submit',e=>{e.preventDefault();const{valid}=validate();if(!valid)return;const data=Object.fromEntries(new FormData(form).entries());saveCadastro(data);form.reset();$$('input,select,textarea',form).forEach(el=>el.setAttribute('aria-invalid','false'));showToast('Cadastro salvo com sucesso!');});}